<!DOCTYPE html>
<html>
<head>
  <title>A1 Drycleaners</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
  body { margin: 0; font-family: "Segoe UI", Arial, sans-serif; background: linear-gradient(135deg, #e0f2fe, #f8fafc); min-height: 100vh; display: flex; justify-content: center; align-items: center; }
  .box { background: white; padding: 26px; border-radius: 16px; width: 92%; max-width: 380px; box-shadow: 0 15px 35px rgba(0,0,0,0.12); }
  h1 { text-align: center; margin-bottom: 22px; font-size: 24px; color: #1e293b; }
  input, select { width: 100%; padding: 14px; margin-bottom: 14px; font-size: 16px; border-radius: 10px; border: 1px solid #cbd5e1; outline: none; box-sizing: border-box;}
  
  /* Buttons */
  button { width: 100%; padding: 15px; font-size: 16px; border-radius: 12px; border: none; color: white; cursor: pointer; margin-bottom: 12px; font-weight: 500; }
  button:active { transform: scale(0.98); }
  
  .primary { background: #2563eb; } 
  .whatsapp { background: #25D366; } 
  .back { background: #64748b; }
  .delete-btn { background: #ef4444; padding: 5px 10px; font-size: 14px; width: auto; margin-left: 5px; }
  .edit-btn { background: #f59e0b; padding: 5px 10px; font-size: 14px; width: auto; }

  /* Cards */
  .bill-card { background: #f8fafc; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px; position: relative; }
  .due { color: #dc2626; font-weight: bold; }
  .paid { color: #16a34a; font-weight: bold; }
  hr { border-top: 1px solid #eee; }

  /* Search Bar */
  #searchBar { border: 2px solid #2563eb; background-color: #f0f9ff; font-weight: bold; }
  
  /* Highlight Labels */
  label { font-size: 14px; font-weight: bold; color: #555; display:block; margin-bottom: 5px;}
  </style>
</head>
<body>

<div class="box" id="home">
  <h1>üß∫ A1 DRYCLEANERS<br>‡§è1 ‡§°‡•ç‡§∞‡§æ‡§Ø‡§ï‡•ç‡§≤‡§ø‡§®‡§∞‡•ç‡§∏</h1>
  <button class="primary" onclick="showAdd()">‚ûï Add Customer</button>
  <button class="primary" onclick="showBill()">üßæ New Bill</button>
  <button class="primary" onclick="showList()">üìã View History & Search</button>
</div>

<div class="box" id="add" style="display:none">
  <h1>Add Customer</h1>
  <input id="nameMarathi" placeholder="‡§®‡§æ‡§µ (Marathi)">
  <input id="nameEnglish" placeholder="Name (English)">
  <input id="mobile" type="number" placeholder="Mobile Number">
  <button class="primary" onclick="saveCustomer()">Save Customer</button>
  <button class="back" onclick="goHome()">‚¨Ö Back</button>
</div>

<div class="box" id="bill" style="display:none">
  <h1>New Bill</h1>
  <select id="billCustomer"></select>
  
  <label>Service Type / ‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞:</label>
  <select id="serviceType" onchange="calculateTotal()">
    <option value="Manual">Direct Amount (Other)</option>
    <option value="Wash Only">Wash Only (‚Çπ80/Kg)</option>
    <option value="Wash + Iron">Wash + Iron (‚Çπ100/Kg)</option>
  </select>

  <div id="weightBox" style="display:none;">
    <input id="weight" type="number" placeholder="Weight in Kg (e.g. 2.5)" onkeyup="calculateTotal()">
  </div>

  <label>Total Amount:</label>
  <input id="total" type="number" placeholder="Total Amount">
  
  <label>Paid Amount:</label>
  <input id="paid" type="number" placeholder="Paid Amount">
  
  <button class="primary" onclick="processBill(false)">üíæ Save Only</button>
  <button class="whatsapp" onclick="processBill(true)">üí¨ Save & WhatsApp</button>
  <button class="back" onclick="goHome()">‚¨Ö Back</button>
</div>

<div class="box" id="list" style="display:none">
  <h1>Records</h1>
  <input id="searchBar" placeholder="üîç Search Name / ‡§®‡§æ‡§µ ‡§∂‡•ã‡§ß‡§æ..." onkeyup="filterData()">
  <div style="text-align:center; margin-bottom:15px;">
    <button class="primary" style="padding:8px 15px; width:auto;" onclick="loadCustomers()">Customers</button>
    <button class="primary" style="padding:8px 15px; width:auto;" onclick="loadBills()">Bills</button>
  </div>
  <div id="listContent"></div>
  <button class="back" onclick="goHome()">‚¨Ö Back</button>
</div>

<script>
let allCustomers = [];
let allBills = [];
let currentMode = "";

// --- NAVIGATION ---
function showAdd() { hideAll(); add.style.display = "block"; }
function showBill() { 
  hideAll(); bill.style.display = "block"; 
  loadCustomerOptions(); 
  serviceType.value = "Manual"; // Reset
  weightBox.style.display = "none";
  weight.value = "";
  total.readOnly = false; // Allow manual edit
}
function showList() { hideAll(); list.style.display = "block"; loadCustomers(); }
function goHome() { hideAll(); home.style.display = "block"; }
function hideAll() { home.style.display = add.style.display = bill.style.display = list.style.display = "none"; }

// --- LOGIC: CALCULATE PRICE ---
function calculateTotal() {
  const type = serviceType.value;
  const w = parseFloat(weight.value);

  if (type === "Manual") {
    weightBox.style.display = "none";
    total.readOnly = false;
    total.placeholder = "Enter Total Amount";
    // Do not clear total value so user can type freely
  } 
  else {
    weightBox.style.display = "block";
    total.readOnly = true; // Lock total field
    
    if (w) {
      if (type === "Wash Only") total.value = Math.round(w * 80);
      if (type === "Wash + Iron") total.value = Math.round(w * 100);
    } else {
      total.value = "";
    }
  }
}

// --- CUSTOMERS ---
function saveCustomer() {
  const customer = { marathi: nameMarathi.value, english: nameEnglish.value, mobile: mobile.value };
  if (!customer.english) return alert("Enter Name");
  fetch("/customers", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(customer) })
  .then(() => { alert("Saved ‚úÖ"); nameMarathi.value=""; nameEnglish.value=""; mobile.value=""; goHome(); });
}

function loadCustomerOptions() {
  billCustomer.innerHTML = "<option>Loading...</option>";
  fetch("/customers").then(res => res.json()).then(data => {
    billCustomer.innerHTML = "<option value=''>Select Customer</option>";
    data.forEach(c => { billCustomer.innerHTML += `<option value='${JSON.stringify(c)}'>${c.english}</option>`; });
  });
}

function deleteCustomer(id) {
  if(!confirm("Delete?")) return;
  fetch("/customers/" + id, { method: "DELETE" }).then(() => loadCustomers());
}

function editCustomer(id, oldMar, oldEng, oldMob) {
  const newMar = prompt("Update Marathi Name:", oldMar);
  const newEng = prompt("Update English Name:", oldEng);
  const newMob = prompt("Update Mobile:", oldMob);
  if(newEng) {
    fetch("/customers/" + id, { 
      method: "PUT", headers: { "Content-Type": "application/json" }, 
      body: JSON.stringify({ marathi: newMar, english: newEng, mobile: newMob }) 
    }).then(() => loadCustomers());
  }
}

// --- BILLS ---
function processBill(sendWhatsApp) {
  if(!billCustomer.value) return alert("Select Customer");
  const c = JSON.parse(billCustomer.value);
  const totalAmt = Number(total.value);
  const paidAmt = Number(paid.value);
  const sType = serviceType.value;
  const w = weight.value ? Number(weight.value) : 0;
  
  if(!totalAmt && totalAmt !== 0) return alert("Enter Total Amount");

  const due = totalAmt - paidAmt;
  const now = new Date().toLocaleString();

  const billData = { 
    customerName: c.english, 
    customerMobile: c.mobile, 
    serviceType: sType,
    weight: w,
    total: totalAmt, 
    paid: paidAmt, 
    due: due, 
    date: now 
  };

  fetch("/bills", { 
    method: "POST", headers: { "Content-Type": "application/json" }, 
    body: JSON.stringify(billData) 
  }).then(() => {
    total.value = ""; paid.value = ""; weight.value = "";
    
    // WhatsApp Logic
    if (sendWhatsApp) {
      let extraInfo = "";
      if (sType !== "Manual") {
        extraInfo = `\n‡§µ‡§ú‡§®: ${w} Kg (${sType})`;
      }
      const msg = `‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞ ${c.english},\n‡§§‡•Å‡§Æ‡§ö‡•á ‡§ï‡§™‡§°‡•á ‡§§‡§Ø‡§æ‡§∞ ‡§Ü‡§π‡•á‡§§ üôèüòä${extraInfo}\n‡§è‡§ï‡•Ç‡§£ ‡§¨‡§ø‡§≤: ‚Çπ${totalAmt}\n‡§ú‡§Æ‡§æ: ‚Çπ${paidAmt}\n‡§¨‡§æ‡§ï‡•Ä: ‚Çπ${due}`;
      window.location.href = "https://wa.me/91" + c.mobile + "?text=" + encodeURIComponent(msg);
    } else {
      alert("Bill Saved ‚úÖ");
    }
  });
}

function deleteBill(id) {
  if(!confirm("Delete?")) return;
  fetch("/bills/" + id, { method: "DELETE" }).then(() => loadBills());
}

function editBill(id, oldTotal, oldPaid) {
  const newTotal = prompt("Total:", oldTotal);
  const newPaid = prompt("Paid:", oldPaid);
  if(newTotal !== null) {
    const due = Number(newTotal) - Number(newPaid);
    fetch("/bills/" + id, {
      method: "PUT", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ total: newTotal, paid: newPaid, due: due })
    }).then(() => loadBills());
  }
}

// --- LOAD DATA & SEARCH ---
function loadCustomers() {
  currentMode = "customers"; searchBar.value = ""; listContent.innerHTML = "Loading...";
  fetch("/customers").then(res => res.json()).then(data => { allCustomers = data; renderList(allCustomers); });
}

function loadBills() {
  currentMode = "bills"; searchBar.value = ""; listContent.innerHTML = "Loading...";
  fetch("/bills").then(res => res.json()).then(data => { allBills = data; renderList(allBills); });
}

function filterData() {
  const term = searchBar.value.toLowerCase();
  if (currentMode === "customers") {
    renderList(allCustomers.filter(c => (c.english && c.english.toLowerCase().includes(term)) || (c.marathi && c.marathi.includes(term)) || (c.mobile && c.mobile.includes(term))));
  } else {
    renderList(allBills.filter(b => (b.customerName && b.customerName.toLowerCase().includes(term)) || (b.date && b.date.includes(term))));
  }
}

function renderList(data) {
  listContent.innerHTML = "";
  if(data.length === 0) { listContent.innerHTML = "<p style='text-align:center'>No results found</p>"; return; }

  if (currentMode === "customers") {
    data.forEach(c => {
      listContent.innerHTML += `
        <div style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
          <b>${c.english}</b> (${c.marathi})<br>üìû ${c.mobile}<br>
          <button class="edit-btn" onclick="editCustomer('${c._id}', '${c.marathi}', '${c.english}', '${c.mobile}')">Edit</button>
          <button class="delete-btn" onclick="deleteCustomer('${c._id}')">Delete</button>
        </div>`;
    });
  } else {
    data.forEach(b => {
      // Show Kg details if available
      let detailText = "";
      if (b.serviceType && b.serviceType !== "Manual") {
        detailText = `<br><span style="color:#2563eb; font-size:14px;">üß¥ ${b.weight} Kg - ${b.serviceType}</span>`;
      }

      listContent.innerHTML += `
        <div class="bill-card">
          <b>${b.customerName}</b><br>
          <span style="color:#555; font-size:13px;">${b.date}</span>
          ${detailText}
          <br>
          Total: ‚Çπ${b.total} | Paid: ‚Çπ${b.paid}<br>
          <span class="${b.due > 0 ? 'due' : 'paid'}">Due: ‚Çπ${b.due}</span><br><br>
          <button class="edit-btn" onclick="editBill('${b._id}', '${b.total}', '${b.paid}')">Edit Amt</button>
          <button class="delete-btn" onclick="deleteBill('${b._id}')">Delete</button>
        </div>`;
    });
  }
}
</script>
</body>
</html>
