import streamlit as st
import sqlite3
import pandas as pd
from datetime import datetime
import urllib.parse

# --- CONFIGURATION ---
st.set_page_config(page_title="Laundry Manager Pro", layout="wide", page_icon="ðŸ§º")

# --- DATABASE MANAGEMENT ---
def init_db():
    conn = sqlite3.connect('laundry_shop.db')
    c = conn.cursor()
    
    # Create Customers Table
    c.execute('''CREATE TABLE IF NOT EXISTS customers
                 (id INTEGER PRIMARY KEY, 
                  name_en TEXT, 
                  name_mr TEXT, 
                  phone TEXT)''')
    
    # Create Orders Table
    c.execute('''CREATE TABLE IF NOT EXISTS orders
                 (id INTEGER PRIMARY KEY, 
                  customer_id INTEGER, 
                  cloth_details TEXT, 
                  total_amount REAL, 
                  paid_amount REAL, 
                  due_amount REAL, 
                  date_time TEXT, 
                  status TEXT,
                  FOREIGN KEY(customer_id) REFERENCES customers(id))''')
    conn.commit()
    conn.close()

def run_query(query, params=(), fetch=False):
    conn = sqlite3.connect('laundry_shop.db')
    c = conn.cursor()
    c.execute(query, params)
    if fetch:
        data = c.fetchall()
        conn.close()
        return data
    conn.commit()
    conn.close()

# Initialize DB on first run
init_db()

# --- SIDEBAR NAVIGATION ---
st.sidebar.title("ðŸ§º Laundry Manager")
menu = st.sidebar.radio("Go to", ["New Order / Entry", "Customer List & Search", "Pending Dues & WhatsApp"])

# --- FUNCTIONS ---

def generate_whatsapp_link(phone, name, due):
    # Ensure phone has country code (Assuming India +91)
    clean_phone = phone.replace(" ", "").replace("-", "")
    if not clean_phone.startswith("91"):
        clean_phone = "91" + clean_phone
    
    message = f"Namaskar {name}, your laundry bill due amount is Rs {due}. Please pay at your earliest convenience. Thank you!"
    encoded_message = urllib.parse.quote(message)
    return f"https://wa.me/{clean_phone}?text={encoded_message}"

# --- PAGE 1: NEW ORDER ---
if menu == "New Order / Entry":
    st.header("ðŸ“ New Customer / Order Entry")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("1. Customer Details")
        cust_phone = st.text_input("Phone Number", placeholder="9876543210")
        
        # Check if customer exists
        existing_cust = None
        if len(cust_phone) >= 10:
            data = run_query("SELECT * FROM customers WHERE phone = ?", (cust_phone,), fetch=True)
            if data:
                existing_cust = data[0]
                st.success(f"Customer Found: {existing_cust[1]} ({existing_cust[2]})")
        
        name_en = st.text_input("Name (English)", value=existing_cust[1] if existing_cust else "")
        name_mr = st.text_input("Name (Marathi)", value=existing_cust[2] if existing_cust else "", help="Use Google Input Tools to type Marathi")

    with col2:
        st.subheader("2. Order Details")
        cloth_details = st.text_area("Cloth Details (Qty & Type)", placeholder="2 Shirts, 1 Pant, 1 Saree")
        date_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        c1, c2 = st.columns(2)
        total_amt = c1.number_input("Total Bill Amount (â‚¹)", min_value=0.0)
        paid_amt = c2.number_input("Amount Paid Now (â‚¹)", min_value=0.0)
        
        due_amt = total_amt - paid_amt
        st.metric("Current Due", f"â‚¹ {due_amt}")

    if st.button("Save Order", type="primary"):
        if cust_phone and name_en:
            # 1. Add/Update Customer
            if not existing_cust:
                run_query("INSERT INTO customers (name_en, name_mr, phone) VALUES (?, ?, ?)", 
                          (name_en, name_mr, cust_phone))
                # Get the new ID
                cust_data = run_query("SELECT id FROM customers WHERE phone = ?", (cust_phone,), fetch=True)
                cust_id = cust_data[0][0]
            else:
                cust_id = existing_cust[0]
            
            # 2. Add Order
            run_query('''INSERT INTO orders (customer_id, cloth_details, total_amount, paid_amount, due_amount, date_time, status)
                         VALUES (?, ?, ?, ?, ?, ?, ?)''', 
                         (cust_id, cloth_details, total_amt, paid_amt, due_amt, date_time, "Received"))
            
            st.success("Order Saved Successfully!")
        else:
            st.error("Please fill Name and Phone Number.")

# --- PAGE 2: CUSTOMER LIST ---
elif menu == "Customer List & Search":
    st.header("ðŸ” Search Records")
    
    search_term = st.text_input("Search by Name (Eng/Mar) or Phone")
    
    query = '''
    SELECT c.name_en, c.name_mr, c.phone, o.cloth_details, o.total_amount, o.due_amount, o.date_time
    FROM orders o
    JOIN customers c ON o.customer_id = c.id
    '''
    
    all_data = run_query(query, fetch=True)
    df = pd.DataFrame(all_data, columns=['English Name', 'Marathi Name', 'Phone', 'Clothes', 'Total', 'Due', 'Date'])
    
    if search_term:
        mask = (
            df['English Name'].str.contains(search_term, case=False, na=False) |
            df['Marathi Name'].str.contains(search_term, case=False, na=False) |
            df['Phone'].str.contains(search_term, case=False, na=False)
        )
        df = df[mask]
    
    st.dataframe(df, use_container_width=True)

# --- PAGE 3: DUES & WHATSAPP ---
elif menu == "Pending Dues & WhatsApp":
    st.header("ðŸ’¸ Pending Dues Management")
    
    # Get only people with dues > 0
    query = '''
    SELECT c.id, c.name_en, c.name_mr, c.phone, SUM(o.due_amount) as total_due
    FROM orders o
    JOIN customers c ON o.customer_id = c.id
    GROUP BY c.id
    HAVING total_due > 0
    '''
    
    dues_data = run_query(query, fetch=True)
    
    if not dues_data:
        st.info("No pending dues from any customer!")
    else:
        st.write("Click the 'Send WhatsApp' button to open a chat with the pre-filled bill message.")
        
        # Create a layout for each debtor
        for row in dues_data:
            c_id, name_en, name_mr, phone, due = row
            
            with st.container():
                col1, col2, col3, col4 = st.columns([2, 2, 2, 2])
                col1.write(f"**{name_en}**")
                col2.write(f"**{name_mr}**")
                col3.write(f"Due: **â‚¹ {due}**")
                
                link = generate_whatsapp_link(phone, name_en, due)
                col4.link_button(f"ðŸ“² WhatsApp {name_en}", link)
                st.divider()